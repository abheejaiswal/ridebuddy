<%- include('partials/sidebar') %>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">

<style>
  .table-hover tbody tr:hover { background-color: #f0f8ff !important; cursor: pointer; transition: background-color 0.3s ease; }
  .table-striped tbody tr:nth-of-type(odd) { background-color: #f9f9f9; }
  .thead-light th { background-color: #e9ecef; font-weight: 600; color: #495057; }
  .table td, .table th { vertical-align: middle; padding: 12px; }
  .badge { font-size: 0.75rem; padding: 0.4em 0.65em; border-radius: 0.35rem; }
  .badge-read { background-color: #28a745; color: white; }
  .badge-unread { background-color: #dc3545; color: white; }
  .form-control, .ts-control { border-radius: 8px !important; min-height: 42px; font-size: 15px; }
  .ts-dropdown { background: #fff !important; border: 1px solid #ddd !important; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 8px !important; z-index: 9999 !important; }
  .ts-dropdown .option { background-color: #fff !important; color: #333 !important; padding: 8px 10px; }
  .ts-dropdown .option:hover { background-color: #f1f1f1 !important; }
  .ts-dropdown > div:first-child { background-color: #fafafa !important; border-bottom: 1px solid #eaeaea; }
  .ts-control { background-color: #fff !important; position: relative; z-index: 1; }
</style>

<div id="content-wrapper" class="d-flex flex-column">
  <div id="content">
    <%- include('partials/header') %>

    <div class="container-fluid" id="container-wrapper">
      <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Notification Management</h1>
      </div>

      <!-- ✅ Send Notification Form -->
      <div class="row mb-4">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
              <h6 class="m-0 font-weight-bold text-primary">Send New Notification</h6>
            </div>
            <div class="card-body">
              <form action="/notification/send" method="POST">
                <div class="form-group mb-3">
                  <label for="user_ids">Select Users</label>
                  <select id="user_ids" name="user_ids[]" multiple placeholder="Select users..." autocomplete="off">
                    <% if (users && users.length > 0) { %>
                      <optgroup>
                        <% users.forEach(user => { %>
                          <option value="<%= user.id %>"><%= user.name %></option>
                        <% }) %>
                      </optgroup>
                    <% } else { %>
                      <option disabled>No users found</option>
                    <% } %>
                  </select>
                </div>

                <div class="form-group mb-3">
                  <label for="title">Title</label>
                  <input type="text" name="title" id="title" class="form-control" required>
                </div>

                <div class="form-group mb-3">
                  <label for="message">Message</label>
                  <textarea name="message" id="message" class="form-control" rows="3" required></textarea>
                </div>

                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-paper-plane"></i> Send Notification
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ Notification Table -->
      <div class="row">
        <div class="col-lg-12 mb-4">
          <div class="card">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
              <h6 class="m-0 font-weight-bold text-primary">All Notifications</h6>
              <!-- ✅ Added multiple delete button -->
              <form id="multiDeleteForm" action="/notification/delete-multiple" method="POST">
                <button type="submit" class="btn btn-danger btn-sm" id="deleteSelectedBtn" disabled>
                  <i class="fas fa-trash-alt"></i> Delete Selected
                </button>
              </form>
            </div>

            <div class="table-responsive p-3">
              <table class="table table-hover table-striped align-items-center table-flush" id="notificationTable">
                <thead class="thead-light">
                  <tr>
                    <!-- ✅ Added checkbox column -->
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>#</th>
                    <th>User ID</th>
                    <th>Title</th>
                    <th>Message</th>
                    <th>Status</th>
                    <th>Created At</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (documents && documents.length > 0) { %>
                    <% documents.forEach((notification, index) => { %>
                      <tr>
                        <!-- ✅ Each row checkbox -->
                        <td><input type="checkbox" name="ids[]" value="<%= notification.id %>" class="rowCheckbox"></td>
                        <td><%= index + 1 %></td>
                        <td><%= notification.user_id %></td>
                        <td><%= notification.title %></td>
                        <td><%= notification.message %></td>
                        <td>
                          <% if (notification.read) { %>
                            <span class="badge badge-read">Read</span>
                          <% } else { %>
                            <span class="badge badge-unread">Unread</span>
                          <% } %>
                        </td>
                        <td><%= new Date(notification.created_at).toLocaleString() %></td>
                        <td>
                          <form action="/notification/delete/<%= notification.id %>" method="POST" 
                                onsubmit="return confirm('Are you sure you want to delete this notification?');"
                                style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                              <i class="fas fa-trash-alt"></i>
                            </button>
                          </form>
                        </td>
                      </tr>
                    <% }) %>
                  <% } else { %>
                    
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- include('partials/footer') %>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<script>
  $(document).ready(function() {
    $('#notificationTable').DataTable({
      pageLength: 10,
      ordering: true,
      searching: true,
      language: {
        search: "Search:",
        lengthMenu: "Show _MENU_ entries",
        info: "Showing _START_ to _END_ of _TOTAL_ entries",
        paginate: { previous: "Previous", next: "Next" }
      }
    });

    // ✅ Handle select all checkboxes
    $('#selectAll').on('change', function() {
      $('.rowCheckbox').prop('checked', $(this).is(':checked'));
      toggleDeleteButton();
    });

    // ✅ Enable/disable delete button
    $('.rowCheckbox').on('change', function() {
      toggleDeleteButton();
    });

    function toggleDeleteButton() {
      const anyChecked = $('.rowCheckbox:checked').length > 0;
      $('#deleteSelectedBtn').prop('disabled', !anyChecked);
    }

    // ✅ On form submit, collect IDs dynamically
    $('#multiDeleteForm').on('submit', function(e) {
      e.preventDefault();
      const selectedIds = $('.rowCheckbox:checked').map(function() { return this.value; }).get();
      if (selectedIds.length === 0) {
        alert('Please select at least one notification.');
        return;
      }

      if (confirm('Are you sure you want to delete selected notifications?')) {
        $('<input>').attr({
          type: 'hidden',
          name: 'ids',
          value: selectedIds.join(',')
        }).appendTo('#multiDeleteForm');
        this.submit();
      }
    });

    // ✅ Tom Select dropdown (same as before)
    const select = new TomSelect("#user_ids", {
      plugins: ['remove_button'],
      maxItems: null,
      sortField: { field: "text", direction: "asc" },
      placeholder: "Select users...",
      render: {
        option: (data, escape) => `<div class="d-flex align-items-center"><input type="checkbox" class="me-2" disabled><span>${escape(data.text)}</span></div>`,
        item: (data, escape) => `<div>${escape(data.text)}</div>`
      },
      onInitialize: function() {
        const control = this;
        const header = document.createElement("div");
        header.innerHTML = `
          <div style="padding:6px 10px; border-bottom:1px solid #eaeaea;">
            <label><input type="checkbox" id="select_all_users"> <b>Select all users</b></label>
          </div>`;
        this.dropdown.insertBefore(header, this.dropdown.firstChild);
        header.querySelector('#select_all_users').addEventListener('change', function() {
          if (this.checked) {
            const allValues = Object.keys(control.options);
            control.setValue(allValues);
          } else {
            control.clear();
          }
        });
      }
    });
  });
</script>
