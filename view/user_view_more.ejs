<%- include('partials/sidebar') %>

<div id="content-wrapper" class="d-flex flex-column">
  <div id="content">
    <%- include('partials/header') %>

    <div class="container-fluid" id="container-wrapper">
      <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">User Details</h1>
        <a href="/users" class="btn btn-secondary">← Back</a>
      </div>

      <main class="row">
        <!-- Left profile card -->
        <div class="col-12 col-lg-4 mb-4">
          <div class="card shadow-sm text-center h-100 p-3 sticky-card">
            <div class="profile-avatar mb-3">
              <% if (user.profile_image) { %>
                <img src="<%= user.profile_image %>" class="rounded-circle shadow" width="100" height="100" style="object-fit:cover;">
              <% } else { %>
                <i class="fa-solid fa-user-circle" style="font-size:80px; color:#2f8bff;"></i>
              <% } %>
            </div>
            <h5 class="fw-bold mb-1"><%= user.name || "N/A" %></h5>
            <div class="wallet mb-3">
              <span class="text-muted">Wallet Balance:</span>
              <div class="fw-bold fs-5 text-success">₹<%= (user.wallet || 0).toFixed(2) %></div>
            </div>
            <div class="contact-info text-start border-top pt-3">
              <p class="mb-2">
                <i class="fa fa-envelope me-2 text-primary"></i>
                <span><%= user.email || "N/A" %></span>
              </p>
              <p class="mb-0">
                <i class="fa fa-phone me-2 text-primary"></i>
                <span><%= user.phone || "N/A" %></span>
              </p>
            </div>
          </div>
        </div>

        <!-- Right panel with tabs -->
        <div class="col-12 col-lg-8 mb-4">
          <div class="card shadow-sm p-3 h-100">
            <!-- Nav tabs -->
            <ul class="nav nav-tabs mb-3" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#publishRide" role="tab">Publish Ride</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#myRides" role="tab">My Rides</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#walletTx" role="tab">Wallet Transactions</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#vehicleList" role="tab">Vehicle List</a>
              </li>
            </ul>

            <!-- Tab content -->
            <div class="tab-content" style="max-height:65vh; overflow:auto;">

              <!-- Publish Rides -->
              <div class="tab-pane fade show active" id="publishRide" role="tabpanel">
                <div class="table-responsive">
                  <table class="table table-bordered table-hover align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Ride ID</th>
                        <th>Pickup</th>
                        <th>Drop-Off</th>
                        <th>Date</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% if (publishRides.length) { %>
                        <% publishRides.forEach(r => { %>
                          <tr>
                            <td><%= r.id %></td>
                            <td><%= r.start_address || "N/A" %></td>
                            <td><%= r.end_address || "N/A" %></td>
                            <td><%= r.ride_date ? new Date(r.ride_date).toISOString().split('T')[0] : "N/A" %></td>
                            <td>
                              <% 
                                const statusMap = {
                                  1: { text: "Publish", class: "badge-soft-info" },
                                  2: { text: "Complete", class: "badge-soft-success" },
                                  3: { text: "Cancel", class: "badge-soft-danger" },
                                  5: { text: "On the Way", class: "badge-soft-warning" }
                                };
                                const status = statusMap[r.status] || { text: "N/A", class: "badge-soft-secondary" };
                              %>
                              <span class="badge <%= status.class %>"><%= status.text %></span>
                            </td>
                          </tr>
                        <% }) %>
                      <% } else { %>
                        <tr><td colspan="5" class="text-center">No Publish Ride Found</td></tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- My Rides -->
              <div class="tab-pane fade" id="myRides" role="tabpanel">
                <div class="table-responsive">
                  <table class="table table-bordered table-hover align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Booking ID</th>
                        <th>Pickup</th>
                        <th>Drop-Off</th>
                        <th>Date</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% if (myRides.length) { %>
                        <% myRides.forEach(r => { %>
                          <tr>
                            <td><%= r.booking_id %></td>
                            <td><%= r.start_address || "N/A" %></td>
                            <td><%= r.end_address || "N/A" %></td>
                            <td><%= r.ride_date ? new Date(r.ride_date).toISOString().split('T')[0] : "N/A" %></td>
                            <td>
                              <% 
                                const statusMap = {
                                  0: { text: "Pending", class: "badge-soft-pending" },
                                  1: { text: "Confirmed", class: "badge-soft-confirmed" },
                                  2: { text: "Cancelled by User", class: "badge-soft-cancelled" },
                                  3: { text: "Cancelled by Driver", class: "badge-soft-cancelled" },
                                  4: { text: "Completed", class: "badge-soft-completed" },
                                  5: { text: "Picked Up", class: "badge-soft-pickedup" },
                                  6: { text: "No-show", class: "badge-soft-noshow" },
                                  7: { text: "Completed with Rating", class: "badge-soft-rated" }
                                };
                                const status = statusMap[r.status] || { text: "N/A", class: "badge-soft-secondary" };
                              %>
                              <span class="badge <%= status.class %>"><%= status.text %></span>
                            </td>
                          </tr>
                        <% }) %>
                      <% } else { %>
                        <tr><td colspan="5" class="text-center">No My Rides Found</td></tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Wallet Transactions -->
              <div class="tab-pane fade" id="walletTx" role="tabpanel">
                <div class="table-responsive">
                  <table class="table table-bordered table-hover align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Transaction ID</th>
                        <th>Amount (₹)</th>
                        <th>Type</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Wallet Balance (₹)</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% if (walletTx.length) { %>
                        <% walletTx.forEach(tx => { %>
                          <tr>
                            <td><%= tx.ref_id || tx.id %></td>
                            <td><%= tx.type === "debit" ? '-' : '' %><%= Math.abs(tx.amount).toFixed(2) %></td>
                            <td><%= tx.type ? tx.type.charAt(0).toUpperCase() + tx.type.slice(1) : "N/A" %></td>
                            <td><%= tx.created_at ? new Date(tx.created_at).toLocaleDateString('en-GB') : "N/A" %></td>
                            <td>
                              <% if(tx.type === "credit") { %>
                                <span class="badge bg-success">Credit</span>
                              <% } else if(tx.type === "debit") { %>
                                <span class="badge bg-danger">Debit</span>
                              <% } else { %>
                                <span class="badge bg-warning">Pending</span>
                              <% } %>
                            </td>
                            <td>₹<%= (tx.balance_after || 0).toFixed(2) %></td>
                          </tr>
                        <% }) %>
                      <% } else { %>
                        <tr>
                          <td colspan="6" class="text-center">No Transactions Found</td>
                        </tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Vehicle List -->
              <div class="tab-pane fade" id="vehicleList" role="tabpanel">
                <div class="table-responsive">
                  <table class="table table-bordered table-hover align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Car Number</th>
                        <th>Brand Name</th>
                        <th>Model</th>
                        <th>Vehicle Color</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% if (vehicles.length) { %>
                        <% vehicles.forEach(v => { %>
                          <tr>
                            <td><%= v.vehicle_number || "N/A" %></td>
                            <td><%= v.brand_name || "N/A" %></td>
                            <td><%= v.model || "N/A" %></td>
                            <td><%= v.vehicle_color || "N/A" %></td>
                          </tr>
                        <% }) %>
                      <% } else { %>
                        <tr><td colspan="5" class="text-center">No Vehicles Found</td></tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>

            </div> <!-- tab-content end -->
          </div>
        </div>
      </main>
    </div>

    <%- include('partials/footer') %>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<style>
.nav-tabs .nav-link.active {
  background-color: #2f8bff;
  color: #fff !important;
  border-radius: 5px 5px 0 0;
}
.sticky-card {
  position: sticky;
  top: 80px;
}

/* Badge Soft Colors */
.badge-soft-info { background-color: #cce5ff; color: #004085; }
.badge-soft-success { background-color: #d4edda; color: #155724; }
.badge-soft-danger { background-color: #f8d7da; color: #721c24; }
.badge-soft-warning { background-color: #fff3cd; color: #856404; }
.badge-soft-secondary { background-color: #e2e3e5; color: #6c757d; }

.badge-soft-pending { background-color: #fff3cd; color: #856404; }
.badge-soft-confirmed { background-color: #cce5ff; color: #004085; }
.badge-soft-cancelled { background-color: #f8d7da; color: #721c24; }
.badge-soft-completed { background-color: #d4edda; color: #155724; }
.badge-soft-pickedup { background-color: #e2e3e5; color: #6c757d; }
.badge-soft-noshow { background-color: #ffe6e6; color: #a71d2a; }
.badge-soft-rated { background-color: #d1ecf1; color: #0c5460; }
</style>
